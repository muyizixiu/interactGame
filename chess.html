<!DOCTYPE html > 
<html>
<head>
	<title>chess</title>
	<style type="text/css">
	#main{
		height: 1200px;
		width: 1200px;
		border:1px solid #333;
	}
	#plat{
		height: 1000px;
		width: 1000px;
		background-image: url(./flat.png);
		background-repeat: repeat;
		margin:10px auto;
		position:relative;
	}
	.chess{
		height: 98px;
		width: 98px;
		border: 1px solid #333;
		position:absolute;
	}
	@keyframes blackChess{
from {background: #666;width: 1px;height:1px;border-radius: 1px;}
to {background: #000;width: 40px;height:40px;border-radius:40px;}
}
@keyframes whiteChess{
from {background: #ddd;width: 1px;height:1px;border-radius: 1px;}
to {background: #fff;width: 40px;height:40px;border-radius:40px;}
}
.shit{
		border:2px solid #444;
		height: 10px;
		width: 1px;
		position: absolute;
		animation: blackChess 2s forwards;
	}
	.whiteChess{


		border:2px solid #eee;
		height: 10px;
		width: 1px;
		position: absolute;
		animation: whiteChess 2s forwards;
	}
	</style>
</head>
<body>
<div id="plat"></div>
<script type="text/javascript">
	var start =false;
	var url="ws://192.168.1.130:81/?";
	var me={
		name:"yang",
		clientType:0,
	}
	var urlPara={
		clientType:0,
			   gName:"chess",
			   roomId:0,
	}
	init()
	main=document.getElementById('plat');
	var plat=new Array();
	var lock=false;
	for (var i = 0; i <=12; i++) {
		plat[i]=[0,0,0,0,0,0,0,0,0,0,0,0,0]
	};
	function IsAllowed(x,y){
		if (plat[x][y]==0){
			return true
		}
		return false
	}
	main.onclick=function  (event) {
		// body...
		x=event.x;
		x=x-main.offsetLeft;
		x=Math.round(x/100);
         y=event.y;
         y=Math.round(y/100);
         if (IsAllowed(x,y)){
         PutChess(x,y);
     }
	}
	// 创建一个Socket实例
if(urlPara["roomId"]){
	url=url+"roomId="+urlPara["roomId"];
}
if(urlPara["clientType"]){
	url=url+"&clientType="+urlPara["clientType"];
	me.clientType=urlPara["clientType"];
}
CreateUrl("gName")
CreateUrl("act")
function CreateUrl(str){
if(urlPara[str]){
	url=url+"&"+str+"="+urlPara[str];
}
}
console.log(url);
var socket = new WebSocket(url); 
// 打开Socket 
socket.onopen = function(event) { 

  // 发送一个初始化消息
  //socket.send(""); 

  // 监听消息
  socket.onmessage = function(event) { 
    console.log('Client received a message',event); 
    data=JSON.parse(event.data)
	    console.log(data)
	    if(data.X&&data.Y){
  		GetChess(data.X,data.Y);
	    }
    if(data.start){
    	start=true
    }
  console.log(data)
  }; 

  // 监听Socket的关闭
  socket.onclose = function(event) { 
    console.log('Client notified socket has closed',event); 
  
  }; 
  // 关闭Socket.... 
  //socket.close() 
};
	function PutChess(x,y){
	    if(!start||me.clientType!=0||lock){
		    return
	    }
		json='{"X":'+x+',"Y":'+y+",\"clientType\":"+me.clientType+'}'
			console.log(json)

		socket.send(json);
			a=x;b=y;c=1;
		x=x*100-15;
		y=y*100-15;
	chess=document.createElement("div")
	chess.style.left=x+"px";
         chess.style.top=y+"px";
	 if(GlobalChess){
		chess.className="shit";
		GlobalChess=false;
		c=1;
	 }else{
		chess.className="whiteChess";
		GlobalChess=true;
		c=2;
	 }
		plat[a][b]=c;
		checkPlat(c,a,b);
		main.appendChild(chess);
		
		lock=true
	}
GlobalChess=true;	
	function GetChess(x,y){
		a=x;b=y;
		x=x*100-15;
		y=y*100-15;
	chess=document.createElement("div")
	chess.style.left=x+"px";
         chess.style.top=y+"px";
	 c=1;
	 if(GlobalChess){
		chess.className="shit";
		GlobalChess=false;
		c=1
	 }else{
		chess.className="whiteChess";
		GlobalChess=true;
		c=2
	 }
		plat[a][b]=c
		checkPlat(c,a,b);
		main.appendChild(chess);

		lock=false;
	}
	function init(){
		location.search.substring(1).split("&").forEach(function(n){tmp=n.split("=");urlPara[tmp[0]]=tmp[1]});
		console.log(urlPara);
	}
	function checkPlat(c,a,b){
		if(c!=1&&c!=2){
			return 0
		}
		n=function(){
			x=a;y=b;
		vict=false;
		num=1;
			left=true;
			right=true;
		for(var i=1;i<12;i++){
			if(left){
			if(plat[x-i][y]==c){
			console.log("left*********",num,c,plat[x-i][y],x,y);
				num++
			}else{
				left=false;
			}
			}
			if(right){
			if(plat[x+i][y]==c){
			console.log("right*********",num,c,plat[x+i][y],x,y);
				num++
			}else{
				right=false;
			}
			}
			console.log("*********",num);
			if(!right&&!left){
				break;
			}
		}
		if(num>=5){
			return num;
		}
		num=1;
		for(var i=1;i<12;i++){
			if(!left){
			if(plat[x][y-i]==c){
				num++
			}else{
				left=true;
			}
			}
			if(!right){
			if(plat[x][y+i]==c){
				num++
			}else{
				right=true;
			}
			}
		}
		if(num>=5){
			return num;
		}
		num=1;
		for(var i=1;i<12;i++){
			if(left){
			if(plat[x-i][y-i]==c){
				num++
			}else{
				left=false;
			}
			}
			if(right){
			if(plat[x+i][y+i]==c){
				num++
			}else{
				right=false;
			}
			}
			if(!right&&!left){
				break;
			}
		}
		if(num>=5){
			return num;
		}
		num=1;
		for(var i=1;i<12;i++){
			if(!left){
			if(plat[x+i][y-i]==c){
				num++
			}else{
				left=true;
			}
			}
			if(!right){
			if(plat[x-i][y+i]==c){
				num++
			}else{
				right=true;
			}
			}
		}
		return num;
		}()
		if(n>=5){
			alert("over");
		}
	}
</script>
</body>
</html>
