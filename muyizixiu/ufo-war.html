<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.0//EN" "http://www.wapforum.org/DTD/xhtml-mobile10.dtd">
<html>
<head>
	<title>ufo-war</title>
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
	<style type="text/css">
	html,body{
		margin:0px;
		padding: 0px;
		position: relative;
		height: 100%;
		width: 100%;
	}
	canvas{
		display: block;
		position: absolute;
		height: 100%;
		width: 100%;
	}

	</style>
	<script type="text/javascript" src="../cfig.js"></script>
	<script type="text/javascript" src="ws.js"></script>
</head>
<body id="body">
<canvas id="ufo-plat"></canvas>
<script type="text/javascript">
	var postion = Math.floor(Math.random()*10);
	document.addEventListener('touchmove', function(e){e.preventDefault()}, false);
	var body=document.getElementById("body");
	var canvas=document.getElementById('ufo-plat');
	var cvs=canvas.getContext("2d");
	var G={
		height:body.offsetHeight,
		width:body.offsetWidth,
		hn:13,
		wn:8,
		i:0,
		j:0,
		startX:10,
		startY:10,
		bulletShort:6,
		bulletLong:18,
		unit:36,
		radius:18,
		timeLock:true,
		lock:true,
		color:["#123","#345","#333"],
		nextData:{
			enemy:{
				x:5,
				y:postion,
				dx:0,
				dy:0,
			},
			ufo:{
				x:5,
				y:postion,
				dx:0,
				dy:0,
			},
			bullet:[],
		},
		fix:false,
		map:Array(),
		init:function() {
			G.map=[[1,2,2,2,2,2,2,0,2,2,2,1,2,2,],[1,2,2,1,2,2,2,0,2,2,2,1,2,2,],[1,2,2,1,2,2,2,0,2,2,2,1,2,2,],[2,2,2,1,2,2,2,0,2,1,2,2,2,2,],[2,2,2,2,1,2,2,0,2,1,2,1,2,2,],[2,2,0,2,1,2,2,0,2,1,2,1,2,2,],[1,2,0,2,2,2,2,0,2,2,0,0,2,2,],[1,2,2,0,2,2,2,0,2,2,0,0,2,2,],[1,2,2,2,2,2,2,0,2,2,0,1,2,2,]];
			for(x in G.map){
				for(y in G.map[x]){
					cvs.fillStyle=G.color[G.map[x][y]];
					cvs.fillRect(x*G.unit+G.startX,y*G.unit+G.startY,G.unit,G.unit);
				}
			}
		},
		restore:function(x,y){
				if(x>=0&&x<=G.wn&&y>=0&&y<=G.hn){
					cvs.fillStyle=G.color[G.map[x][y]];
					cvs.fillRect(x*G.unit+G.startX,y*G.unit+G.startY,G.unit,G.unit);
				}
					x+=1;
				if(x>=0&&x<=G.wn&&y>=0&&y<=G.hn){
					cvs.fillStyle=G.color[G.map[x][y]];
					cvs.fillRect(x*G.unit+G.startX,y*G.unit+G.startY,G.unit,G.unit);
				}
					x-=1;
					y+=1;
				if(x>=0&&x<=G.wn&&y>=0&&y<=G.hn){
					cvs.fillStyle=G.color[G.map[x][y]];
					cvs.fillRect(x*G.unit+G.startX,y*G.unit+G.startY,G.unit,G.unit);
				}
					y-=1;
					x-=1;
				if(x>=0&&x<=G.wn&&y>=0&&y<=G.hn){
					cvs.fillStyle=G.color[G.map[x][y]];
					cvs.fillRect(x*G.unit+G.startX,y*G.unit+G.startY,G.unit,G.unit);
				}
					x+=1;
					y-=1;
				if(x>=0&&x<=G.wn&&y>=0&&y<=G.hn){
					cvs.fillStyle=G.color[G.map[x][y]];
					cvs.fillRect(x*G.unit+G.startX,y*G.unit+G.startY,G.unit,G.unit);
				}
		},
		freshFrame:function(){
			ws.send(JSON.stringify(G.nextData));
			G.fix=true;
			G.timeLock=true;
			setTimeout(G.freshFrame,1000);
		}
	}
	canvas.height=G.height;
	canvas.width=G.width;
	G.init();
	var ufo={
		id:0,
		x:5,
		y:postion,
		alpha:1,
		r:G.radius,
		dx:0,
		dy:0,
		nextData:{
			x:5,
			y:2,
		},
		draw:function(){
			var i=0;
			//cvs.clearRect(0,0,G.width,G.height);
			var from={x:ufo.x,y:ufo.y};
			var to={x:ufo.nextData.x,y:ufo.nextData.y};
			var int=setInterval(function(){
				i++;
				G.restore(from.x,from.y);
				G.restore(to.x,to.y);
				var x=from.x+i*(to.x-from.x)/10;
				var y=from.y+i*(to.y-from.y)/10;
				var r=G.radius/2;
				var alpha=1*ufo.alpha;
				cvs.beginPath();
				cvs.arc(x*G.unit+G.startX+G.radius,y*G.unit+G.radius+G.startY,r,0,2*Math.PI);
				cvs.fillStyle="rgba(182,235,246,"+alpha+")";
				cvs.fill();
				cvs.beginPath();
				var r=G.radius;
				if(i%6==0){
					alpha=0.1*ufo.alpha;
				}else{
					alpha=0;
				}
				cvs.arc(x*G.unit+G.startX+G.radius,y*G.unit+G.radius+G.startY,r,0,2*Math.PI);
				cvs.fillStyle="rgba(112,135,156,"+alpha+")";
				cvs.fill();
				if(i>=10){
					clearInterval(int);
				}
			},100);
			ufo.x=ufo.nextData.x;
			ufo.y=ufo.nextData.y;
			// console.log("i")
			// console.log(G.i)
			// console.log(new Date().getTime());
			//cvs.stroke();
		},
		move:function(){
			//if((ufo.x<1&&ufo.dx<0)||(ufo.dx>0&&ufo.x>G.width/G.unit-2)){
			//	ufo.dx=0;
			//}
			//if((ufo.y<1&ufo.dy<0)||(ufo.dy>0&&ufo.y>G.height/G.unit-2)){
			//	ufo.dy=0;
			//}
			ufo.draw();
			G.fix=false;
			ufo.next();
			//console.log(ufo.x,ufo.y)
			window.setTimeout(ufo.move,1000);
		},
		next:function(){
			if((ufo.x<1&&ufo.dx<0)||(ufo.dx>0&&ufo.x>=G.wn)){
				ufo.dx=0;
			}
			if((ufo.y<1&ufo.dy<0)||(ufo.dy>0&&ufo.y>=G.hn)){
				ufo.dy=0;
			}
			//console.log((G.map[ufo.x+ufo.dx][ufo.y+ufo.dy]))
			switch(G.map[ufo.x+ufo.dx][ufo.y+ufo.dy]){
				case 2:
					ufo.alpha=1;
					break;
				case 1:
					ufo.dx=0;
					ufo.dy=0;
					break;
				case 0:
					ufo.alpha=0;
					break;
			}
			ufo.nextData.x=ufo.x+ufo.dx;
			ufo.nextData.y=ufo.y+ufo.dy;
			G.nextData.ufo=ufo.nextData;
			//ws.send(JSON.stringify(ufo.data));
		}
	}
	var enemy={
		id:0,
		x:5,
		y:10,
		alpha:1,
		r:G.radius,
		dx:0,
		dy:0,
		nextData:{
			x:5,
 			y:5,
		},
		dy:0,
		draw:function(){
			var i=0;
			//cvs.clearRect(0,0,G.width,G.height);
			var from={x:enemy.x,y:enemy.y};
			var to={x:enemy.nextData.x,y:enemy.nextData.y};
			var int=setInterval(function(){
				i++;
				G.restore(from.x,from.y);
				G.restore(to.x,to.y);
				var x=from.x+i*(to.x-from.x)/10;
				var y=from.y+i*(to.y-from.y)/10;
				var r=G.radius/2;
				var alpha=1*enemy.alpha;
				cvs.beginPath();
				cvs.arc(x*G.unit+G.startX+G.radius,y*G.unit+G.radius+G.startY,r,0,2*Math.PI);
				cvs.fillStyle="rgba(82,105,126,"+alpha+")";
				cvs.fill();
				cvs.beginPath();
				r=G.radius;
				if(i%6==0){
					alpha=0.1*enemy.alpha;
				}else{
					alpha=0;
				}
				cvs.arc(x*G.unit+G.startX+G.radius,y*G.unit+G.radius+G.startY,r,0,2*Math.PI);
				cvs.fillStyle="rgba(112,135,156,"+alpha+")";
				cvs.fill();
				if(i>=10){
					clearInterval(int);
				}
			},100);
			enemy.x=enemy.nextData.x;
			enemy.y=enemy.nextData.y;
			// console.log("i")
			// console.log(G.i)
			// console.log(new Date().getTime());
			//cvs.stroke();
			//cvs.clearRect(0,0,G.width,G.height);
		},
		move:function(){
			G.restore(enemy.x,enemy.y);
			enemy.nextData.x=G.nextData.enemy.x;
			enemy.nextData.y=G.nextData.enemy.y;
			enemy.now();
			enemy.draw();
			window.setTimeout(enemy.move,1000);
		},
		now:function(){
			//console.log((G.map[enemy.x+enemy.dx][enemy.y+enemy.dy]))
			switch(G.map[enemy.nextData.x][enemy.nextData.y]){
				case 2:
					enemy.alpha=1;
					break;
				case 1:
					enemy.dx=0;
					enemy.dy=0;
					break;
				case 0:
					enemy.alpha=0;
					break;
			}
		}
	}
	function bullet(x,y,dx,dy){
		if(dx==0&&dy==0){
			return
		}
		var self=this;
		if(Math.abs(dx)>Math.abs(dy)){
			this.height=G.bulletShort;
			this.width=G.bulletLong;
		}else{
			this.height=G.bulletLong;
			this.width=G.bulletShort;
		}
		this.x=x;
		this.y=y;
		this.color="rgba(255,0,0,0.5)";
		this.draw=function(){
			cvs.fillStyle=this.color;
			cvs.fillRect(this.x*G.unit+G.unit/2-this.width/2+G.startX,this.y*G.unit+G.startY,this.width,this.height);
		};
		this.move=function(){
			G.restore(self.x,self.y);
			//self.x=G.nextData.self.x;
			//self.y=G.nextData.self.y;
			self.x+=2*dx;
			self.y+=2*dy;
			self.draw();
			setTimeout(self.move,1000);
		};
		G.nextData.bullet.push(this);
		this.move();
	}
	canvas.addEventListener("touchstart",function(e){
		sx=e.touches[0].pageX;
		sy=e.touches[0].pageY;
	});
	canvas.addEventListener("touchmove",function(e){
		ex=e.touches[0].pageX;
		ey=e.touches[0].pageY;
	})
	canvas.addEventListener("touchend",function(e){
		if(G.lock){
			return
		}
		if(typeof(ex)=="undefined"||ex==0){
			ex=sx;
			ey=sy;
		}
		x=ex-sx;
		y=ey-sy;
		ex=0;
		console.log(x*x+y*y)
		if(x*x+y*y<10){
			new bullet(ufo.x,ufo.y,ufo.dx,ufo.dy);
			return
			// if(G.timeLock){
			// 	G.timeLock=false;
			// 	if(G.fix){
			// 		setTimeout(function(){
			// 			if(Math.abs(x)>Math.abs(y)){
			// 				ufo.dx=(x/Math.abs(x));
			// 				ufo.dy=0;
			// 				ufo.next();
			// 			}else{
			// 				ufo.dy=(y/Math.abs(y));
			// 				ufo.dx=0;
			// 				ufo.next();
			// 			}
			// 		},500);
			// 		return;
			// 	}
			// 	if(Math.abs(x)>Math.abs(y)){
			// 			ufo.dx=(x/Math.abs(x));
			// 			ufo.dy=0;
			// 			ufo.next();
			// 	}else{
			// 			ufo.dy=(y/Math.abs(y));
			// 			ufo.dx=0;
			// 			ufo.next();
			// 	}
			// }
		}
			if(G.timeLock){
				G.timeLock=false;
				if(G.fix){
					setTimeout(function(){
						if(Math.abs(x)>Math.abs(y)){
							ufo.dx=(x/Math.abs(x));
							ufo.dy=0;
							ufo.next();
						}else{
							ufo.dy=(y/Math.abs(y));
							ufo.dx=0;
							ufo.next();
						}
					},500);
					return;
				}
				if(Math.abs(x)>Math.abs(y)){
						ufo.dx=(x/Math.abs(x));
						ufo.dy=0;
						ufo.next();
				}else{
						ufo.dy=(y/Math.abs(y));
						ufo.dx=0;
						ufo.next();
				}
			}
	})
	//ufo.move();
</script>
</body>
</html>
